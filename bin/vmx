#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var commander = require('commander');
var colorful = require('colorful');

var pkg = require('../package');

var logger = require('../lib/logger');
var vmx = require('../index')


commander
  .description(pkg.description)
  .option('-v, --version', 'output version number')
  .option('-r, --recursive', 'do recursively')
  .option('-R, --reverse', 'view all files include specified file')
  .option('-d, --debug', 'show debug message')
  .option('-D, --directives [s]', 'directives relate to file including', parseDerectives)
  .option('-t, --to [s]', 'path to save the translated files')
  .option('-T, --template [s]', 'be used with "-t", specifies target template language')
  .on('version', function() {
    console.log('\n  ' + colorful.cyan(pkg.version) + '\n');
    process.exit(0);
  }).helpInformation = helpInfo;

commander.parse(process.argv);


var options = {};

['recursive', 'reverse', 'directives', 'to', 'template'].forEach(function(item, idx, list) {
  if (commander[item]) options[item] = commander[item];
});

commander.args.forEach(function(item, idx, list) {
  if (path.extname(item) === '.vm') {
    options.file = item;
  } else {
    options.variable = item;
  }
});

logger.debug(options);


function helpInfo() {
  return [
    '',
    colorful.cyan('  ' + this.description()),
    '',
    colorful.green('  Usage:'),
    '    ' + this._name + ' [file.vm] [variable] ' + this.usage(),
    '',
    colorful.green('  Options:'),
    '' + this.optionHelp().replace(/^/gm, '    '),
    '',
    colorful.green('  More Info:'),
    '    ' + colorful.underline('https://github.com/fool2fish/vmx'),
    '',
    ''
  ].join('\n');
}


function parseDerectives(raw) {
  if (raw) {
    var rt = {}
    raw.split(',').forEach(function(item, idx, list) {
      var temp = item.split(':');
      rt[temp[0]] = temp[1];
    });
    return rt;
  } else {
    return;
  }
}


